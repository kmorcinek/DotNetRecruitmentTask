name: Build

on:
  push:
    branches:
      - '**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --no-restore --configuration Release

  e2e-tests:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Start infrastructure
      run: docker compose up -d postgres-product postgres-inventory rabbitmq

    - name: Wait for infrastructure
      run: sleep 10

    - name: Build solution
      run: dotnet build --configuration Release

    - name: Start ProductService
      run: |
        cd src/ProductService/ProductService.API
        nohup dotnet run --no-build --configuration Release --urls "http://localhost:5044" > productservice.log 2>&1 &
        echo $! > productservice.pid
      env:
        ConnectionStrings__DefaultConnection: "Host=localhost;Port=5434;Database=productdb;Username=postgres;Password=postgres"
        RabbitMQ__Host: "localhost"
        RabbitMQ__Username: "guest"
        RabbitMQ__Password: "guest"
        Jwt__Secret: "your-super-secret-key-min-32-chars-long-for-security"
        Jwt__Issuer: "ProductService"
        Jwt__Audience: "ProductService"

    - name: Start StockService
      run: |
        cd src/Stock/Stock.API
        nohup dotnet run --no-build --configuration Release --urls "http://localhost:5132" > stockservice.log 2>&1 &
        echo $! > stockservice.pid
      env:
        ConnectionStrings__DefaultConnection: "Host=localhost;Port=5433;Database=inventorydb;Username=postgres;Password=postgres"
        RabbitMQ__Host: "localhost"
        RabbitMQ__Username: "guest"
        RabbitMQ__Password: "guest"
        Jwt__Secret: "your-super-secret-key-min-32-chars-long-for-security"
        Jwt__Issuer: "InventoryService"
        Jwt__Audience: "InventoryService"

    - name: Wait for services to start
      run: |
        echo "Waiting for ProductService..."
        for i in {1..30}; do
          if curl -s http://localhost:5044/health > /dev/null 2>&1 || curl -s http://localhost:5044 > /dev/null 2>&1; then
            echo "ProductService is up"
            break
          fi
          echo "Attempt $i: ProductService not ready yet..."
          sleep 2
        done

        echo "Waiting for StockService..."
        for i in {1..30}; do
          if curl -s http://localhost:5132/health > /dev/null 2>&1 || curl -s http://localhost:5132 > /dev/null 2>&1; then
            echo "StockService is up"
            break
          fi
          echo "Attempt $i: StockService not ready yet..."
          sleep 2
        done

    - name: Run E2E tests
      run: dotnet test tests/E2E.Tests/E2E.Tests.csproj --no-build --configuration Release --logger "console;verbosity=detailed"

    - name: Show service logs on failure
      if: failure()
      run: |
        echo "=== ProductService logs ==="
        cat src/ProductService/ProductService.API/productservice.log || echo "No logs found"
        echo "=== StockService logs ==="
        cat src/Stock/Stock.API/stockservice.log || echo "No logs found"

    - name: Stop services
      if: always()
      run: |
        if [ -f src/ProductService/ProductService.API/productservice.pid ]; then
          kill $(cat src/ProductService/ProductService.API/productservice.pid) || true
        fi
        if [ -f src/Stock/Stock.API/stockservice.pid ]; then
          kill $(cat src/Stock/Stock.API/stockservice.pid) || true
        fi
